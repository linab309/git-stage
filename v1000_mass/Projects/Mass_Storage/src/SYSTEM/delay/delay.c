#include "delay.h"
//////////////////////////////////////////////////////////////////////////////////	 
//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö»ï¿½ï¿½Ñ§Ï°Ê¹ï¿½Ã£ï¿½Î´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½É£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Îºï¿½ï¿½ï¿½Í¾
//Mini STM32ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
//Ê¹ï¿½ï¿½SysTickï¿½ï¿½ï¿½ï¿½Í¨ï¿½ï¿½ï¿½ï¿½Ä£Ê½ï¿½ï¿½ï¿½Ó³Ù½ï¿½ï¿½Ð¹ï¿½ï¿½ï¿½
//ï¿½ï¿½ï¿½ï¿½delay_us,delay_ms
//ï¿½ï¿½ï¿½ï¿½Ô­ï¿½ï¿½@ALIENTEK
//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ì³:www.openedv.com
//ï¿½Þ¸ï¿½ï¿½ï¿½ï¿½ï¿½:2010/5/27
//ï¿½æ±¾ï¿½ï¿½V1.2
//ï¿½ï¿½È¨ï¿½ï¿½ï¿½Ð£ï¿½ï¿½ï¿½ï¿½ï¿½Ø¾ï¿½ï¿½ï¿?
//Copyright(C) ï¿½ï¿½ï¿½ï¿½Ô­ï¿½ï¿½ 2009-2019
//All rights reserved
//********************************************************************************
//V1.2ï¿½Þ¸ï¿½Ëµï¿½ï¿½
//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½ï¿½Ðµï¿½ï¿½Ã³ï¿½ï¿½ï¿½ï¿½ï¿½Ñ­ï¿½ï¿½ï¿½Ä´ï¿½ï¿½ï¿½
//ï¿½ï¿½Ö¹ï¿½ï¿½Ê±ï¿½ï¿½×¼È·,ï¿½ï¿½ï¿½ï¿½do whileï¿½á¹¹!
//////////////////////////////////////////////////////////////////////////////////	 
static u8  fac_us=0;//usï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
static u16 fac_ms=0;//msï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
//ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½Ó³Ùºï¿½ï¿½ï¿½
//SYSTICKï¿½ï¿½Ê±ï¿½Ó¹Ì¶ï¿½ÎªHCLKÊ±ï¿½Óµï¿½1/8
//SYSCLK:ÏµÍ³Ê±ï¿½ï¿½



void delay_init(u8 SYSCLK)
{


  /* Setup SysTick Timer for 1 msec interrupts  */
//  if (SysTick_Config(SystemCoreClock /1000))
  { 
    /* Capture error */ 
  //  while (1);
  }

  #if 1
	SysTick->CTRL|=0x00000004;//bit2ï¿½ï¿½ï¿?,Ñ¡ï¿½ï¿½ï¿½â²¿Ê±ï¿½ï¿½  HCLK/8
	SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK);	//Ñ¡ï¿½ï¿½ï¿½â²¿Ê±ï¿½ï¿½  HCLK/8
	if(SYSCLK<8)
	{
		fac_us=1;		    
		fac_ms=420;	
	}
	else
	{
		fac_us=SYSCLK/8;		    	
		fac_ms=(u16)fac_us*1000;	
	}
	// printf("dleay_init :%d \r\n", SYSCLK);
#endif	
}								    
//ï¿½ï¿½Ê±nms
//×¢ï¿½ï¿½nmsï¿½Ä·ï¿½Î§
//SysTick->LOADÎª24Î»ï¿½Ä´ï¿½ï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½ï¿½Ê±Î?:
//nms<=0xffffff*8*1000/SYSCLK
//SYSCLKï¿½ï¿½Î»ÎªHz,nmsï¿½ï¿½Î»Îªms
//ï¿½ï¿½72Mï¿½ï¿½ï¿½ï¿½ï¿½ï¿½,nms<=1864 
void delay_ms(u16 nms)
{	
//TimingDelay = nms;
#if 1
	u32 temp;		   
	SysTick->LOAD=(u32)nms*fac_ms;//Ê±ï¿½ï¿½ï¿½ï¿½ï¿?(SysTick->LOADÎª24bit)
	SysTick->VAL =0x00;           //ï¿½ï¿½Õ¼ï¿½ï¿½ï¿½ï¿½ï¿?
	SysTick->CTRL=0x01 ;          //ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½  
	do
	{
		temp=SysTick->CTRL;
	}
	while(temp&0x01&&!(temp&(1<<16)));//ï¿½È´ï¿½Ê±ï¿½äµ½ï¿½ï¿½   
	SysTick->CTRL=0x00;       //ï¿½Ø±Õ¼ï¿½ï¿½ï¿½ï¿½ï¿½
	SysTick->VAL =0X00;       //ï¿½ï¿½Õ¼ï¿½ï¿½ï¿½ï¿½ï¿?	  	    
	#endif
}   
//ï¿½ï¿½Ê±nus
//nusÎªÒªï¿½ï¿½Ê±ï¿½ï¿½usï¿½ï¿½.		    								   
void delay_us(u32 nus)
{	
//TimingDelay = nus;
#if 1
	u32 temp;	    	 
	SysTick->LOAD=nus*fac_us; //Ê±ï¿½ï¿½ï¿½ï¿½ï¿?	  		 
	SysTick->VAL=0x00;        //ï¿½ï¿½Õ¼ï¿½ï¿½ï¿½ï¿½ï¿?
	SysTick->CTRL=0x01 ;      //ï¿½ï¿½Ê¼ï¿½ï¿½ï¿½ï¿½ 	 
	do
	{
		temp=SysTick->CTRL;
	}
	while(temp&0x01&&!(temp&(1<<16)));//ï¿½È´ï¿½Ê±ï¿½äµ½ï¿½ï¿½   
	SysTick->CTRL=0x00;       //ï¿½Ø±Õ¼ï¿½ï¿½ï¿½ï¿½ï¿½
	SysTick->VAL =0X00;       //ï¿½ï¿½Õ¼ï¿½ï¿½ï¿½ï¿½ï¿?	 
	#endif
}





































